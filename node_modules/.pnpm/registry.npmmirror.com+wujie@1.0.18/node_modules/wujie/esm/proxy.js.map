{"version":3,"file":"proxy.js","names":["patchElementEffect","renderIframeReplaceApp","renderElementToContainer","pushUrlToWindow","documentProxyProperties","rawDocumentQuerySelector","WUJIE_TIPS_RELOAD_DISABLED","getTargetValue","anchorElementGenerator","getDegradeIframe","isCallable","checkProxyFunction","warn","stopMainAppRun","locationHrefSet","iframe","value","appHostPath","contentWindow","__WUJIE","shadowRoot","id","degrade","document","degradeAttrs","url","test","hrefElement","pathname","search","hash","hrefFlag","iframeBody","call","contentDocument","documentElement","window","decodeURIComponent","parentElement","host","proxyGenerator","urlElement","mainHostPath","proxyWindow","Proxy","get","target","p","proxyLocation","Object","getOwnPropertyDescriptor","proxy","descriptor","configurable","writable","set","has","proxyDocument","_fakeDocument","propKey","rawCreateElement","__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__","rawCreateTextNode","__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__","apply","_createElement","_ctx","args","rawCreateMethod","element","href","querySelectorAll","arg","scripts","res","error","querySelector","ctx","__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__","rawPropMap","firstElementChild","ownerProperties","shadowProperties","shadowMethods","documentProperties","documentMethods","concat","includes","toString","activeElement","body","_fakeLocation","location","replace","ownKeys","keys","filter","key","_target","enumerable","localGenerator","sandbox","defineProperties","createElement","createTextNode","documentURI","URL","getElementsByTagName","tagName","modifyLocalProperties","modifyProperties","forEach","defineProperty","bind","locationKeys","constantKey","reload"],"sources":["../src/proxy.ts"],"sourcesContent":["import { patchElementEffect, renderIframeReplaceApp } from \"./iframe\";\nimport { renderElementToContainer } from \"./shadow\";\nimport { pushUrlToWindow } from \"./sync\";\nimport { documentProxyProperties, rawDocumentQuerySelector } from \"./common\";\nimport { WUJIE_TIPS_RELOAD_DISABLED } from \"./constant\";\nimport {\n  getTargetValue,\n  anchorElementGenerator,\n  getDegradeIframe,\n  isCallable,\n  checkProxyFunction,\n  warn,\n  stopMainAppRun,\n} from \"./utils\";\n\n/**\n * location href 的set劫持操作\n */\nfunction locationHrefSet(iframe: HTMLIFrameElement, value: string, appHostPath: string): boolean {\n  const { shadowRoot, id, degrade, document, degradeAttrs } = iframe.contentWindow.__WUJIE;\n  let url = value;\n  if (!/^http/.test(url)) {\n    let hrefElement = anchorElementGenerator(url);\n    url = appHostPath + hrefElement.pathname + hrefElement.search + hrefElement.hash;\n    hrefElement = null;\n  }\n  iframe.contentWindow.__WUJIE.hrefFlag = true;\n  if (degrade) {\n    const iframeBody = rawDocumentQuerySelector.call(iframe.contentDocument, \"body\");\n    renderElementToContainer(document.documentElement, iframeBody);\n    renderIframeReplaceApp(window.decodeURIComponent(url), getDegradeIframe(id).parentElement, degradeAttrs);\n  } else renderIframeReplaceApp(url, shadowRoot.host.parentElement, degradeAttrs);\n  pushUrlToWindow(id, url);\n  return true;\n}\n\n/**\n * 非降级情况下window、document、location代理\n */\nexport function proxyGenerator(\n  iframe: HTMLIFrameElement,\n  urlElement: HTMLAnchorElement,\n  mainHostPath: string,\n  appHostPath: string\n): {\n  proxyWindow: Window;\n  proxyDocument: Object;\n  proxyLocation: Object;\n} {\n  const proxyWindow = new Proxy(iframe.contentWindow, {\n    get: (target: Window, p: PropertyKey): any => {\n      // location进行劫持\n      if (p === \"location\") {\n        return target.__WUJIE.proxyLocation;\n      }\n      // 判断自身\n      if (p === \"self\" || (p === \"window\" && Object.getOwnPropertyDescriptor(window, \"window\").get)) {\n        return target.__WUJIE.proxy;\n      }\n      // 不要绑定this\n      if (p === \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__\" || p === \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__\") {\n        return target[p];\n      }\n      // https://262.ecma-international.org/8.0/#sec-proxy-object-internal-methods-and-internal-slots-get-p-receiver\n      const descriptor = Object.getOwnPropertyDescriptor(target, p);\n      if (descriptor?.configurable === false && descriptor?.writable === false) {\n        return target[p];\n      }\n      // 修正this指针指向\n      return getTargetValue(target, p);\n    },\n\n    set: (target: Window, p: PropertyKey, value: any) => {\n      checkProxyFunction(value);\n      target[p] = value;\n      return true;\n    },\n\n    has: (target: Window, p: PropertyKey) => p in target,\n  });\n\n  // proxy document\n  const proxyDocument = new Proxy(\n    {},\n    {\n      get: function (_fakeDocument, propKey) {\n        const document = window.document;\n        const { shadowRoot, proxyLocation } = iframe.contentWindow.__WUJIE;\n        // iframe初始化完成后，webcomponent还未挂在上去，此时运行了主应用代码，必须中止\n        if (!shadowRoot) stopMainAppRun();\n        const rawCreateElement = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__;\n        const rawCreateTextNode = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__;\n        // need fix\n        if (propKey === \"createElement\" || propKey === \"createTextNode\") {\n          return new Proxy(document[propKey], {\n            apply(_createElement, _ctx, args) {\n              const rawCreateMethod = propKey === \"createElement\" ? rawCreateElement : rawCreateTextNode;\n              const element = rawCreateMethod.apply(iframe.contentDocument, args);\n              patchElementEffect(element, iframe.contentWindow);\n              return element;\n            },\n          });\n        }\n        if (propKey === \"documentURI\" || propKey === \"URL\") {\n          return (proxyLocation as Location).href;\n        }\n\n        // from shadowRoot\n        if (\n          propKey === \"getElementsByTagName\" ||\n          propKey === \"getElementsByClassName\" ||\n          propKey === \"getElementsByName\"\n        ) {\n          return new Proxy(shadowRoot.querySelectorAll, {\n            apply(querySelectorAll, _ctx, args) {\n              let arg = args[0];\n              if (_ctx !== iframe.contentDocument) {\n                return _ctx[propKey].apply(_ctx, args);\n              }\n\n              if (propKey === \"getElementsByTagName\" && arg === \"script\") {\n                return iframe.contentDocument.scripts;\n              }\n              if (propKey === \"getElementsByClassName\") arg = \".\" + arg;\n              if (propKey === \"getElementsByName\") arg = `[name=\"${arg}\"]`;\n\n              // FIXME: This string must be a valid CSS selector string; if it's not, a SyntaxError exception is thrown;\n              // so we should ensure that the program can execute normally in case of exceptions.\n              // reference: https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelectorAll\n\n              let res: NodeList[] | [];\n              try {\n                res = querySelectorAll.call(shadowRoot, arg);\n              } catch (error) {\n                res = [];\n              }\n\n              return res;\n            },\n          });\n        }\n        if (propKey === \"getElementById\") {\n          return new Proxy(shadowRoot.querySelector, {\n            // case document.querySelector.call\n            apply(target, ctx, args) {\n              if (ctx !== iframe.contentDocument) {\n                return ctx[propKey]?.apply(ctx, args);\n              }\n              return (\n                target.call(shadowRoot, `[id=\"${args[0]}\"]`) ||\n                iframe.contentWindow.__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__.call(\n                  iframe.contentWindow.document,\n                  `#${args[0]}`\n                )\n              );\n            },\n          });\n        }\n        if (propKey === \"querySelector\" || propKey === \"querySelectorAll\") {\n          const rawPropMap = {\n            querySelector: \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__\",\n            querySelectorAll: \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__\",\n          };\n          return new Proxy(shadowRoot[propKey], {\n            apply(target, ctx, args) {\n              if (ctx !== iframe.contentDocument) {\n                return ctx[propKey]?.apply(ctx, args);\n              }\n              // 二选一，优先shadowDom，除非采用array合并，排除base，防止对router造成影响\n              return (\n                target.apply(shadowRoot, args) ||\n                (args[0] === \"base\"\n                  ? null\n                  : iframe.contentWindow[rawPropMap[propKey]].call(iframe.contentWindow.document, args[0]))\n              );\n            },\n          });\n        }\n        if (propKey === \"documentElement\" || propKey === \"scrollingElement\") return shadowRoot.firstElementChild;\n        if (propKey === \"forms\") return shadowRoot.querySelectorAll(\"form\");\n        if (propKey === \"images\") return shadowRoot.querySelectorAll(\"img\");\n        if (propKey === \"links\") return shadowRoot.querySelectorAll(\"a\");\n        const { ownerProperties, shadowProperties, shadowMethods, documentProperties, documentMethods } =\n          documentProxyProperties;\n        if (ownerProperties.concat(shadowProperties).includes(propKey.toString())) {\n          if (propKey === \"activeElement\" && shadowRoot.activeElement === null) return shadowRoot.body;\n          return shadowRoot[propKey];\n        }\n        if (shadowMethods.includes(propKey.toString())) {\n          return getTargetValue(shadowRoot, propKey) ?? getTargetValue(document, propKey);\n        }\n        // from window.document\n        if (documentProperties.includes(propKey.toString())) {\n          return document[propKey];\n        }\n        if (documentMethods.includes(propKey.toString())) {\n          return getTargetValue(document, propKey);\n        }\n      },\n    }\n  );\n\n  // proxy location\n  const proxyLocation = new Proxy(\n    {},\n    {\n      get: function (_fakeLocation, propKey) {\n        const location = iframe.contentWindow.location;\n        if (\n          propKey === \"host\" ||\n          propKey === \"hostname\" ||\n          propKey === \"protocol\" ||\n          propKey === \"port\" ||\n          propKey === \"origin\"\n        ) {\n          return urlElement[propKey];\n        }\n        if (propKey === \"href\") {\n          return location[propKey].replace(mainHostPath, appHostPath);\n        }\n        if (propKey === \"reload\") {\n          warn(WUJIE_TIPS_RELOAD_DISABLED);\n          return () => null;\n        }\n        if (propKey === \"replace\") {\n          return new Proxy(location[propKey], {\n            apply(replace, _ctx, args) {\n              return replace.call(location, args[0]?.replace(appHostPath, mainHostPath));\n            },\n          });\n        }\n        return getTargetValue(location, propKey);\n      },\n      set: function (_fakeLocation, propKey, value) {\n        // 如果是跳转链接的话重开一个iframe\n        if (propKey === \"href\") {\n          return locationHrefSet(iframe, value, appHostPath);\n        }\n        iframe.contentWindow.location[propKey] = value;\n        return true;\n      },\n      ownKeys: function () {\n        return Object.keys(iframe.contentWindow.location).filter((key) => key !== \"reload\");\n      },\n      getOwnPropertyDescriptor: function (_target, key) {\n        return { enumerable: true, configurable: true, value: this[key] };\n      },\n    }\n  );\n  return { proxyWindow, proxyDocument, proxyLocation };\n}\n\n/**\n * 降级情况下document、location代理处理\n */\nexport function localGenerator(\n  iframe: HTMLIFrameElement,\n  urlElement: HTMLAnchorElement,\n  mainHostPath: string,\n  appHostPath: string\n): {\n  proxyDocument: Object;\n  proxyLocation: Object;\n} {\n  // 代理 document\n  const proxyDocument = {};\n  const sandbox = iframe.contentWindow.__WUJIE;\n  // 特殊处理\n  Object.defineProperties(proxyDocument, {\n    createElement: {\n      get: () => {\n        return function (...args) {\n          const element = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__.apply(\n            iframe.contentDocument,\n            args\n          );\n          patchElementEffect(element, iframe.contentWindow);\n          return element;\n        };\n      },\n    },\n    createTextNode: {\n      get: () => {\n        return function (...args) {\n          const element = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__.apply(\n            iframe.contentDocument,\n            args\n          );\n          patchElementEffect(element, iframe.contentWindow);\n          return element;\n        };\n      },\n    },\n    documentURI: {\n      get: () => (sandbox.proxyLocation as Location).href,\n    },\n    URL: {\n      get: () => (sandbox.proxyLocation as Location).href,\n    },\n    getElementsByTagName: {\n      get() {\n        return function (...args) {\n          const tagName = args[0];\n          if (tagName === \"script\") {\n            return iframe.contentDocument.scripts as any;\n          }\n          return sandbox.document.getElementsByTagName(tagName) as any;\n        };\n      },\n    },\n  });\n  // 普通处理\n  const {\n    modifyLocalProperties,\n    modifyProperties,\n    ownerProperties,\n    shadowProperties,\n    shadowMethods,\n    documentProperties,\n    documentMethods,\n  } = documentProxyProperties;\n  modifyProperties\n    .filter((key) => !modifyLocalProperties.includes(key))\n    .concat(ownerProperties, shadowProperties, shadowMethods, documentProperties, documentMethods)\n    .forEach((key) => {\n      Object.defineProperty(proxyDocument, key, {\n        get: () => {\n          const value = sandbox.document?.[key];\n          return isCallable(value) ? value.bind(sandbox.document) : value;\n        },\n      });\n    });\n\n  // 代理 location\n  const proxyLocation = {};\n  const location = iframe.contentWindow.location;\n  const locationKeys = Object.keys(location);\n  const constantKey = [\"host\", \"hostname\", \"port\", \"protocol\", \"port\"];\n  constantKey.forEach((key) => {\n    proxyLocation[key] = urlElement[key];\n  });\n  Object.defineProperties(proxyLocation, {\n    href: {\n      get: () => location.href.replace(mainHostPath, appHostPath),\n      set: (value) => {\n        locationHrefSet(iframe, value, appHostPath);\n      },\n    },\n    reload: {\n      get() {\n        warn(WUJIE_TIPS_RELOAD_DISABLED);\n        return () => null;\n      },\n    },\n  });\n  locationKeys\n    .filter((key) => !constantKey.concat([\"href\", \"reload\"]).includes(key))\n    .forEach((key) => {\n      Object.defineProperty(proxyLocation, key, {\n        get: () => (isCallable(location[key]) ? location[key].bind(location) : location[key]),\n      });\n    });\n  return { proxyDocument, proxyLocation };\n}\n"],"mappings":"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"}